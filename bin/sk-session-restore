#!/bin/bash
# sk-session-restore - Restore ShellKeeper sessions after GNOME session restart
#
# This script helps restore terminal windows connected to
# ShellKeeper sessions that survived a GNOME session crash,
# with their original terminal profiles.
#
# Usage:
#   sk-session-restore              # Interactive session picker
#   sk-session-restore --list       # Just list sessions
#   sk-session-restore --picker     # Show interactive picker (same as no args)
#   sk-session-restore --auto       # Auto-restore all sessions with profiles

SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
SK_SCRIPT="$SCRIPT_DIR/sk"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get list of active ShellKeeper sessions with their profiles
get_sessions() {
    "$SK_SCRIPT" ls 2>/dev/null | grep -E '^\s+\S+' | while read -r line; do
        # Extract session name (first word)
        echo "$line" | awk '{print $1}'
    done
}

# Get session info including profile
get_session_info() {
    local session="$1"
    "$SK_SCRIPT" info "$session" 2>/dev/null
}

# Show interactive session picker
show_picker() {
    echo -e "${BLUE}=======================================================${NC}"
    echo -e "${GREEN}  ShellKeeper Session Restore${NC}"
    echo -e "${BLUE}=======================================================${NC}"
    echo ""

    local sessions=()
    while IFS= read -r session; do
        [ -n "$session" ] && sessions+=("$session")
    done < <(get_sessions)

    if [ ${#sessions[@]} -eq 0 ]; then
        echo -e "${YELLOW}No active ShellKeeper sessions found.${NC}"
        echo ""
        echo "Would you like to create a new session? (y/n)"
        read -r answer
        if [[ "$answer" =~ ^[Yy] ]]; then
            "$SK_SCRIPT" new
        fi
        return
    fi

    echo -e "Found ${GREEN}${#sessions[@]}${NC} active session(s):"
    echo ""

    local i=1
    for session in "${sessions[@]}"; do
        # Get profile info
        local profile
        profile=$("$SK_SCRIPT" info "$session" 2>/dev/null | grep "Profile:" | sed 's/.*Profile: //')
        if [ "$profile" = "none" ] || [ -z "$profile" ]; then
            echo -e "  ${BLUE}[$i]${NC} $session"
        else
            echo -e "  ${BLUE}[$i]${NC} $session ${YELLOW}[$profile]${NC}"
        fi
        ((i++))
    done

    echo ""
    echo -e "  ${BLUE}[a]${NC} Restore all (with original profiles)"
    echo -e "  ${BLUE}[n]${NC} Create new session"
    echo -e "  ${BLUE}[q]${NC} Quit"
    echo ""
    echo -n "Select session: "
    read -r choice

    case "$choice" in
        [0-9]*)
            if [ "$choice" -ge 1 ] && [ "$choice" -le ${#sessions[@]} ]; then
                local selected="${sessions[$((choice-1))]}"
                echo -e "Restoring ${GREEN}$selected${NC} with profile..."
                "$SK_SCRIPT" restore "$selected"
            else
                echo "Invalid selection"
            fi
            ;;
        a|A)
            echo "Restoring all sessions with their profiles..."
            "$SK_SCRIPT" restore-all
            ;;
        n|N)
            echo -n "Session name (or press Enter for auto): "
            read -r name
            if [ -n "$name" ]; then
                "$SK_SCRIPT" new "$name"
            else
                "$SK_SCRIPT" new
            fi
            ;;
        q|Q)
            echo "Goodbye!"
            ;;
        *)
            echo "Invalid choice"
            ;;
    esac
}

# Main
case "${1:-}" in
    --list|-l)
        sessions=$(get_sessions)
        if [ -z "$sessions" ]; then
            echo "No active ShellKeeper sessions"
        else
            echo "Active ShellKeeper sessions:"
            echo "$sessions" | while read -r s; do
                profile=$("$SK_SCRIPT" info "$s" 2>/dev/null | grep "Profile:" | sed 's/.*Profile: //')
                if [ "$profile" = "none" ] || [ -z "$profile" ]; then
                    echo "  $s"
                else
                    echo "  $s [$profile]"
                fi
            done
        fi
        ;;
    --picker|-p|"")
        show_picker
        ;;
    --auto|-a)
        "$SK_SCRIPT" restore-all
        ;;
    --help|-h)
        echo "sk-session-restore - Restore ShellKeeper sessions after login"
        echo ""
        echo "Usage:"
        echo "  sk-session-restore          Interactive session picker"
        echo "  sk-session-restore --list   List active sessions with profiles"
        echo "  sk-session-restore --picker Show interactive picker"
        echo "  sk-session-restore --auto   Auto-restore all sessions with profiles"
        echo ""
        echo "This script helps restore terminal windows connected to"
        echo "ShellKeeper sessions that survived a GNOME session crash,"
        echo "with their original terminal profiles."
        ;;
    *)
        show_picker
        ;;
esac
