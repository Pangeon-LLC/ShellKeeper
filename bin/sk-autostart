#!/bin/bash
# sk-autostart - Check for surviving ShellKeeper sessions on login
#
# This script is meant to run at GNOME session startup. It checks if
# there are any surviving ShellKeeper sessions and prompts the user
# to restore them with their original terminal profiles.

SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
SK_SCRIPT="$SCRIPT_DIR/sk"

# Count active sessions using sk ls
count_active_sessions() {
    local count
    count=$("$SK_SCRIPT" ls 2>/dev/null | grep -E '^\s+\S+' | wc -l)
    echo "$count"
}

# Get session names
get_sessions() {
    "$SK_SCRIPT" ls 2>/dev/null | grep -E '^\s+\S+' | awk '{print $1}'
}

# Main
session_count=$(count_active_sessions)

if [ "$session_count" -gt 0 ]; then
    # Use zenity for a nice GUI prompt if available
    if command -v zenity &>/dev/null; then
        sessions=$(get_sessions | tr '\n' ', ' | sed 's/,$//')

        choice=$(zenity --question \
            --title="ShellKeeper Sessions Found" \
            --text="Found $session_count surviving ShellKeeper session(s):\n$sessions\n\nWould you like to restore them with their original terminal profiles?" \
            --ok-label="Restore All" \
            --cancel-label="Later" \
            --extra-button="Pick Sessions" \
            --width=400 2>&1)

        exit_code=$?

        if [ $exit_code -eq 0 ]; then
            # User clicked "Restore All"
            "$SK_SCRIPT" restore-all
        elif [ "$choice" = "Pick Sessions" ]; then
            # User clicked "Pick Sessions" - open interactive picker
            gnome-terminal --title="Session Restore" -- "$SCRIPT_DIR/sk-session-restore" --picker
        fi
        # exit_code 1 means "Later" was clicked - do nothing
    else
        # Fallback: use notify-send and open picker
        if command -v notify-send &>/dev/null; then
            notify-send "ShellKeeper" "Found $session_count surviving session(s). Run 'sk restore-all' to restore them."
        fi
    fi
fi
