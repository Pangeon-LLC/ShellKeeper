#!/bin/bash
# ShellKeeper Prompt Helper - Updates prompt in existing sessions

if [ -n "$SHELLKEEPER_SESSION" ]; then
    if [ -n "$BASH_VERSION" ]; then
        # Bash - prepend to PS1 if not already there
        if [[ "$PS1" != *"[$SHELLKEEPER_SESSION]"* ]]; then
            export PS1="[$SHELLKEEPER_SESSION] ${PS1:-\u@\h:\w\$ }"
            echo "✓ Prompt updated with session name"
        else
            echo "✓ Prompt already shows session name"
        fi
    elif [ -n "$ZSH_VERSION" ]; then
        # Zsh - handle different prompt variables
        if [[ -n "$ZSH_THEME" ]]; then
            # oh-my-zsh user - modify PROMPT
            if [[ "$PROMPT" != *"[$SHELLKEEPER_SESSION]"* ]]; then
                # Check if there's already a virtual env prefix and preserve it
                if [[ "$PROMPT" =~ ^\([^)]*\)[[:space:]]*(.*) ]]; then
                    # Extract the venv prefix and the rest of the prompt
                    VENV_PREFIX="${PROMPT%% *} "
                    REST_PROMPT="${PROMPT#* }"
                    export PROMPT="${VENV_PREFIX}[$SHELLKEEPER_SESSION] ${REST_PROMPT}"
                else
                    export PROMPT="[$SHELLKEEPER_SESSION] ${PROMPT}"
                fi
                echo "✓ Prompt updated with session name (oh-my-zsh)"
            else
                echo "✓ Prompt already shows session name"
            fi
        elif [[ -n "$PROMPT" ]]; then
            # Using PROMPT variable
            if [[ "$PROMPT" != *"[$SHELLKEEPER_SESSION]"* ]]; then
                export PROMPT="[$SHELLKEEPER_SESSION] ${PROMPT}"
                echo "✓ Prompt updated with session name"
            else
                echo "✓ Prompt already shows session name"
            fi
        else
            # Using PS1 (less common in zsh)
            if [[ "$PS1" != *"[$SHELLKEEPER_SESSION]"* ]]; then
                export PS1="[$SHELLKEEPER_SESSION] ${PS1:-%n@%m:%~%# }"
                echo "✓ Prompt updated with session name (PS1)"
            else
                echo "✓ Prompt already shows session name"
            fi
        fi
    else
        echo "⚠️  Unknown shell - manually set PS1 to include [$SHELLKEEPER_SESSION]"
    fi
else
    echo "✗ Not in a ShellKeeper session"
fi